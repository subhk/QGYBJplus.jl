<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Particle Advection · QGYBJ+.jl</title><meta name="title" content="Particle Advection · QGYBJ+.jl"/><meta property="og:title" content="Particle Advection · QGYBJ+.jl"/><meta property="twitter:title" content="Particle Advection · QGYBJ+.jl"/><meta name="description" content="Documentation for QGYBJ+.jl."/><meta property="og:description" content="Documentation for QGYBJ+.jl."/><meta property="twitter:description" content="Documentation for QGYBJ+.jl."/><meta property="og:url" content="https://subhk.github.io/QGYBJplus.jl/stable/advanced/particles/"/><meta property="twitter:url" content="https://subhk.github.io/QGYBJplus.jl/stable/advanced/particles/"/><link rel="canonical" href="https://subhk.github.io/QGYBJplus.jl/stable/advanced/particles/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/custom.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">QGYBJ+.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../../concepts/">Key Concepts</a></li><li><a class="tocitem" href="../../getting_started/">Installation</a></li><li><a class="tocitem" href="../../quickstart/">Quick Start</a></li><li><a class="tocitem" href="../../worked_example/">Worked Example</a></li></ul></li><li><span class="tocitem">Physics &amp; Theory</span><ul><li><a class="tocitem" href="../../physics/overview/">Model Overview</a></li><li><a class="tocitem" href="../../physics/qg_equations/">QG Equations</a></li><li><a class="tocitem" href="../../physics/ybj_plus/">YBJ+ Wave Model</a></li><li><a class="tocitem" href="../../physics/wave_mean/">Wave-Mean Interaction</a></li><li><a class="tocitem" href="../../physics/numerical_methods/">Numerical Methods</a></li></ul></li><li><span class="tocitem">User Guide</span><ul><li><a class="tocitem" href="../../guide/configuration/">Configuration</a></li><li><a class="tocitem" href="../../guide/stratification/">Stratification</a></li><li><a class="tocitem" href="../../guide/initial_conditions/">Initial Conditions</a></li><li><a class="tocitem" href="../../guide/simulation/">Running Simulations</a></li><li><a class="tocitem" href="../../guide/io/">I/O and Output</a></li><li><a class="tocitem" href="../../guide/diagnostics/">Diagnostics</a></li></ul></li><li><span class="tocitem">Advanced Topics</span><ul><li><a class="tocitem" href="../parallel/">MPI Parallelization</a></li><li class="is-active"><a class="tocitem" href>Particle Advection</a><ul class="internal"><li><a class="tocitem" href="#Overview"><span>Overview</span></a></li><li><a class="tocitem" href="#Generalized-Lagrangian-Mean-(GLM)-Framework"><span>Generalized Lagrangian Mean (GLM) Framework</span></a></li><li><a class="tocitem" href="#Quick-Start"><span>Quick Start</span></a></li><li><a class="tocitem" href="#Configuration-Options"><span>Configuration Options</span></a></li><li><a class="tocitem" href="#Interpolation-Methods"><span>Interpolation Methods</span></a></li><li><a class="tocitem" href="#Particle-Initialization"><span>Particle Initialization</span></a></li><li><a class="tocitem" href="#Boundary-Conditions"><span>Boundary Conditions</span></a></li><li><a class="tocitem" href="#Trajectory-Output"><span>Trajectory Output</span></a></li><li><a class="tocitem" href="#Output-Variables"><span>Output Variables</span></a></li><li><a class="tocitem" href="#Parallel-Execution"><span>Parallel Execution</span></a></li><li><a class="tocitem" href="#Visualization"><span>Visualization</span></a></li><li><a class="tocitem" href="#Key-Data-Structures"><span>Key Data Structures</span></a></li><li><a class="tocitem" href="#References"><span>References</span></a></li><li><a class="tocitem" href="#API-Reference"><span>API Reference</span></a></li></ul></li><li><a class="tocitem" href="../parallel_particles/">Parallel Particle Algorithm</a></li><li><a class="tocitem" href="../interpolation/">Interpolation</a></li><li><a class="tocitem" href="../performance/">Performance Tips</a></li></ul></li><li><span class="tocitem">API Reference</span><ul><li><a class="tocitem" href="../../api/types/">Core Types</a></li><li><a class="tocitem" href="../../api/grid_state/">Grid &amp; State</a></li><li><a class="tocitem" href="../../api/physics/">Physics Functions</a></li><li><a class="tocitem" href="../../api/timestepping/">Time Stepping</a></li><li><a class="tocitem" href="../../api/particles/">Particles</a></li><li><a class="tocitem" href="../../api/">Full Index</a></li></ul></li><li><a class="tocitem" href="../../troubleshooting/">Troubleshooting</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Advanced Topics</a></li><li class="is-active"><a href>Particle Advection</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Particle Advection</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/subhk/QGYBJplus.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/subhk/QGYBJplus.jl/blob/main/docs/src/advanced/particles.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="particles"><a class="docs-heading-anchor" href="#particles">Particle Advection</a><a id="particles-1"></a><a class="docs-heading-anchor-permalink" href="#particles" title="Permalink"></a></h1><p>This page describes Lagrangian particle tracking in QGYBJ+.jl using the Generalized Lagrangian Mean (GLM) framework.</p><h2 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h2><p>Particle tracking allows you to:</p><ul><li>Follow <strong>fluid parcels</strong> as they move with the flow</li><li>Compute <strong>Lagrangian statistics</strong> (dispersion, diffusivity)</li><li>Track <strong>tracer concentrations</strong> along trajectories</li><li>Study <strong>mixing</strong> and <strong>transport</strong> in QG-YBJ+ dynamics</li></ul><h2 id="Generalized-Lagrangian-Mean-(GLM)-Framework"><a class="docs-heading-anchor" href="#Generalized-Lagrangian-Mean-(GLM)-Framework">Generalized Lagrangian Mean (GLM) Framework</a><a id="Generalized-Lagrangian-Mean-(GLM)-Framework-1"></a><a class="docs-heading-anchor-permalink" href="#Generalized-Lagrangian-Mean-(GLM)-Framework" title="Permalink"></a></h2><p>QGYBJ+.jl implements particle advection using the <strong>Generalized Lagrangian Mean (GLM)</strong> framework, which cleanly separates the slowly-evolving mean trajectory from fast wave oscillations.</p><h3 id="Position-Decomposition"><a class="docs-heading-anchor" href="#Position-Decomposition">Position Decomposition</a><a id="Position-Decomposition-1"></a><a class="docs-heading-anchor-permalink" href="#Position-Decomposition" title="Permalink"></a></h3><p>The physical particle position <span>$\mathbf{x}(t)$</span> is decomposed into:</p><p class="math-container">\[\mathbf{x}(t) = \mathbf{X}(t) + \boldsymbol{\xi}(\mathbf{X}(t), t)\]</p><p>where:</p><ul><li><span>$\mathbf{X}(t)$</span> is the <strong>mean position</strong> (Lagrangian-mean trajectory)</li><li><span>$\boldsymbol{\xi}$</span> is the <strong>wave displacement</strong> (fast oscillatory component)</li></ul><p>In component form:</p><p class="math-container">\[x = X + \xi_x, \quad y = Y + \xi_y, \quad z = Z + \xi_z\]</p><h3 id="Mean-Position-Advection"><a class="docs-heading-anchor" href="#Mean-Position-Advection">Mean Position Advection</a><a id="Mean-Position-Advection-1"></a><a class="docs-heading-anchor-permalink" href="#Mean-Position-Advection" title="Permalink"></a></h3><p>The mean position evolves according to the <strong>QG velocity</strong> (which is the Lagrangian-mean flow):</p><p class="math-container">\[\frac{d\mathbf{X}}{dt} = \mathbf{u}_{QG}(\mathbf{X}, t)\]</p><p>where the QG velocities are:</p><p class="math-container">\[u_{QG} = -\frac{\partial \psi}{\partial y}, \quad v_{QG} = \frac{\partial \psi}{\partial x}\]</p><p>The mean vertical position <span>$Z$</span> is advected by <span>$w_{QG}$</span> from the omega equation (or remains constant if <code>use_3d_advection=false</code>).</p><p>This is time-stepped using <strong>Euler method</strong>:</p><p class="math-container">\[\mathbf{X}^{n+1} = \mathbf{X}^n + \Delta t \cdot \mathbf{u}_{QG}(\mathbf{X}^n, t^n)\]</p><h3 id="Wave-Displacement"><a class="docs-heading-anchor" href="#Wave-Displacement">Wave Displacement</a><a id="Wave-Displacement-1"></a><a class="docs-heading-anchor-permalink" href="#Wave-Displacement" title="Permalink"></a></h3><p>The wave displacement is <strong>not</strong> time-stepped—it is reconstructed diagnostically from the wave field at each output time.</p><h4 id="Horizontal-Wave-Displacement"><a class="docs-heading-anchor" href="#Horizontal-Wave-Displacement">Horizontal Wave Displacement</a><a id="Horizontal-Wave-Displacement-1"></a><a class="docs-heading-anchor-permalink" href="#Horizontal-Wave-Displacement" title="Permalink"></a></h4><p>From the wave velocity amplitude <span>$LA$</span>:</p><p class="math-container">\[\xi_x + i\xi_y = \text{Re}\left\{\frac{LA}{-if_0} e^{-if_0 t}\right\}\]</p><p>where <span>$LA$</span> uses the YBJ operator:</p><ul><li><span>$L = \partial_z(f_0^2/N^2)\partial_z$</span></li><li><span>$L^+ = L - k_h^2/4$</span> (YBJ+ operator)</li><li>Since <span>$L^+A$</span> is the evolved variable: <span>$LA = L^+A + (k_h^2/4)A$</span></li></ul><h4 id="Vertical-Wave-Displacement-(Equation-2.10)"><a class="docs-heading-anchor" href="#Vertical-Wave-Displacement-(Equation-2.10)">Vertical Wave Displacement (Equation 2.10)</a><a id="Vertical-Wave-Displacement-(Equation-2.10)-1"></a><a class="docs-heading-anchor-permalink" href="#Vertical-Wave-Displacement-(Equation-2.10)" title="Permalink"></a></h4><p>From Asselin &amp; Young (2019) equation (2.10):</p><p class="math-container">\[\xi_z = \xi_{z,\cos} \cos(f_0 t) + \xi_{z,\sin} \sin(f_0 t)\]</p><p>where:</p><p class="math-container">\[\xi_{z,\cos} = \frac{f_0}{N^2} w_{\sin}, \quad \xi_{z,\sin} = -\frac{f_0}{N^2} w_{\cos}\]</p><p>with:</p><p class="math-container">\[w_{\cos} = \text{Re}(\partial_x A_z) + \text{Im}(\partial_y A_z), \quad
w_{\sin} = \text{Im}(\partial_x A_z) - \text{Re}(\partial_y A_z)\]</p><h3 id="Why-GLM?"><a class="docs-heading-anchor" href="#Why-GLM?">Why GLM?</a><a id="Why-GLM?-1"></a><a class="docs-heading-anchor-permalink" href="#Why-GLM?" title="Permalink"></a></h3><table><tr><th style="text-align: left">Aspect</th><th style="text-align: left">Benefit</th></tr><tr><td style="text-align: left"><strong>Numerical stability</strong></td><td style="text-align: left">Mean trajectory uses larger <span>$\Delta t$</span> (not constrained by wave period)</td></tr><tr><td style="text-align: left"><strong>Physical clarity</strong></td><td style="text-align: left">Separates slow (QG) and fast (wave) dynamics</td></tr><tr><td style="text-align: left"><strong>Efficiency</strong></td><td style="text-align: left">Wave displacement is diagnostic, not prognostic</td></tr><tr><td style="text-align: left"><strong>Accuracy</strong></td><td style="text-align: left">No accumulation of phase errors in wave oscillations</td></tr></table><hr/><h2 id="Quick-Start"><a class="docs-heading-anchor" href="#Quick-Start">Quick Start</a><a id="Quick-Start-1"></a><a class="docs-heading-anchor-permalink" href="#Quick-Start" title="Permalink"></a></h2><h3 id="Co-Evolution-with-Fluid-(Recommended)"><a class="docs-heading-anchor" href="#Co-Evolution-with-Fluid-(Recommended)">Co-Evolution with Fluid (Recommended)</a><a id="Co-Evolution-with-Fluid-(Recommended)-1"></a><a class="docs-heading-anchor-permalink" href="#Co-Evolution-with-Fluid-(Recommended)" title="Permalink"></a></h3><p>Particles can be passed to the timestep functions to co-evolve with the fluid:</p><pre><code class="language-julia hljs">using QGYBJplus

# Setup model
par = default_params(Lx=500e3, Ly=500e3, Lz=4000.0, nx=64, ny=64, nz=32)
G, S, plans, a = setup_model(par)

# Create particle configuration (100 particles at depth 2000 m)
particle_config = particles_in_box(-2000.0; x_max=G.Lx, y_max=G.Ly, nx=10, ny=10)

# Create and initialize particle tracker
tracker = ParticleTracker(particle_config, G)
initialize_particles!(tracker, particle_config)

# Particles co-evolve with the fluid
first_projection_step!(S, G, par, plans; a=a, particle_tracker=tracker, current_time=0.0)
for step in 1:nsteps
    current_time = step * par.dt
    leapfrog_step!(Snp1, Sn, Snm1, G, par, plans; a=a,
                   particle_tracker=tracker, current_time=current_time)
    Snm1, Sn, Snp1 = Sn, Snp1, Snm1
end

# Save trajectories
write_particle_trajectories(&quot;particles.nc&quot;, tracker)</code></pre><h3 id="Manual-Advection"><a class="docs-heading-anchor" href="#Manual-Advection">Manual Advection</a><a id="Manual-Advection-1"></a><a class="docs-heading-anchor-permalink" href="#Manual-Advection" title="Permalink"></a></h3><p>For more control:</p><pre><code class="language-julia hljs"># Create and initialize tracker
tracker = ParticleTracker(particle_config, G)
initialize_particles!(tracker, particle_config)

# Advect manually after each timestep
for step in 1:nsteps
    timestep!(sim)
    advect_particles!(tracker, sim.state, sim.grid, par.dt, sim.current_time;
                      params=par)
end

write_particle_trajectories(&quot;particles.nc&quot;, tracker)</code></pre><hr/><h2 id="Configuration-Options"><a class="docs-heading-anchor" href="#Configuration-Options">Configuration Options</a><a id="Configuration-Options-1"></a><a class="docs-heading-anchor-permalink" href="#Configuration-Options" title="Permalink"></a></h2><h3 id="2D-vs-3D-Advection"><a class="docs-heading-anchor" href="#2D-vs-3D-Advection">2D vs 3D Advection</a><a id="2D-vs-3D-Advection-1"></a><a class="docs-heading-anchor-permalink" href="#2D-vs-3D-Advection" title="Permalink"></a></h3><table><tr><th style="text-align: left">Setting</th><th style="text-align: left">Behavior</th></tr><tr><td style="text-align: left"><code>use_3d_advection = true</code> (default)</td><td style="text-align: left">Mean position Z is advected by <span>$w_{QG}$</span></td></tr><tr><td style="text-align: left"><code>use_3d_advection = false</code></td><td style="text-align: left">Z remains at initial depth (only <span>$\xi_z$</span> varies)</td></tr></table><p>When <code>use_3d_advection = false</code>, the physical vertical position is:</p><p class="math-container">\[z(t) = Z_0 + \xi_z(t)\]</p><p>where <span>$Z_0$</span> is the initial depth and <span>$\xi_z(t)$</span> is the oscillating wave displacement.</p><pre><code class="language-julia hljs"># Particles stay at fixed mean depth, only wave displacement varies
config = particles_in_box(-2000.0;
    x_max=G.Lx, y_max=G.Ly,
    use_3d_advection=false
)</code></pre><h3 id="Vertical-Velocity-Source"><a class="docs-heading-anchor" href="#Vertical-Velocity-Source">Vertical Velocity Source</a><a id="Vertical-Velocity-Source-1"></a><a class="docs-heading-anchor-permalink" href="#Vertical-Velocity-Source" title="Permalink"></a></h3><table><tr><th style="text-align: left">Setting</th><th style="text-align: left">Vertical velocity for mean advection</th></tr><tr><td style="text-align: left"><code>use_ybj_w = false</code> (default)</td><td style="text-align: left">QG omega equation</td></tr><tr><td style="text-align: left"><code>use_ybj_w = true</code></td><td style="text-align: left">YBJ wave-induced <span>$w$</span></td></tr></table><p>Note: The vertical wave displacement <span>$\xi_z$</span> is always computed from equation (2.10), regardless of this setting.</p><hr/><h2 id="Interpolation-Methods"><a class="docs-heading-anchor" href="#Interpolation-Methods">Interpolation Methods</a><a id="Interpolation-Methods-1"></a><a class="docs-heading-anchor-permalink" href="#Interpolation-Methods" title="Permalink"></a></h2><p>Velocity must be interpolated from the grid to particle positions.</p><table><tr><th style="text-align: left">Method</th><th style="text-align: left">Stencil</th><th style="text-align: left">Order</th><th style="text-align: left">Best For</th></tr><tr><td style="text-align: left"><code>TRILINEAR</code> (default)</td><td style="text-align: left">8 points</td><td style="text-align: left">O(h²)</td><td style="text-align: left">Speed, rough fields</td></tr><tr><td style="text-align: left"><code>TRICUBIC</code></td><td style="text-align: left">64 points</td><td style="text-align: left">O(h⁴)</td><td style="text-align: left">Accuracy, smooth fields</td></tr><tr><td style="text-align: left"><code>QUINTIC</code></td><td style="text-align: left">216 points</td><td style="text-align: left">O(h⁶)</td><td style="text-align: left">Highest accuracy</td></tr><tr><td style="text-align: left"><code>ADAPTIVE</code></td><td style="text-align: left">8-64</td><td style="text-align: left">Variable</td><td style="text-align: left">Mixed conditions</td></tr></table><pre><code class="language-julia hljs">config = particles_in_box(-2000.0; x_max=G.Lx, y_max=G.Ly,
                          interpolation_method=TRICUBIC)</code></pre><hr/><h2 id="Particle-Initialization"><a class="docs-heading-anchor" href="#Particle-Initialization">Particle Initialization</a><a id="Particle-Initialization-1"></a><a class="docs-heading-anchor-permalink" href="#Particle-Initialization" title="Permalink"></a></h2><h3 id="Simple-Constructors"><a class="docs-heading-anchor" href="#Simple-Constructors">Simple Constructors</a><a id="Simple-Constructors-1"></a><a class="docs-heading-anchor-permalink" href="#Simple-Constructors" title="Permalink"></a></h3><table><tr><th style="text-align: left">Constructor</th><th style="text-align: left">Description</th></tr><tr><td style="text-align: left"><code>particles_in_box(z; ...)</code></td><td style="text-align: left">Uniform grid at fixed z</td></tr><tr><td style="text-align: left"><code>particles_in_circle(z; ...)</code></td><td style="text-align: left">Circular disk at fixed z</td></tr><tr><td style="text-align: left"><code>particles_in_grid_3d(; ...)</code></td><td style="text-align: left">Uniform 3D grid</td></tr><tr><td style="text-align: left"><code>particles_in_layers(z_levels; ...)</code></td><td style="text-align: left">Multiple z-levels</td></tr><tr><td style="text-align: left"><code>particles_random_3d(n; ...)</code></td><td style="text-align: left">Random 3D distribution</td></tr><tr><td style="text-align: left"><code>particles_custom(positions; ...)</code></td><td style="text-align: left">User-specified positions</td></tr></table><p>Note: Vertical coordinate is <code>z ∈ [-Lz, 0]</code> with <code>z = 0</code> at the surface.</p><h3 id="Examples"><a class="docs-heading-anchor" href="#Examples">Examples</a><a id="Examples-1"></a><a class="docs-heading-anchor-permalink" href="#Examples" title="Permalink"></a></h3><pre><code class="language-julia hljs"># 100 particles at depth 2000 m
config = particles_in_box(-2000.0; x_max=G.Lx, y_max=G.Ly, nx=10, ny=10)

# Circular patch
config = particles_in_circle(-1000.0; center=(250e3, 250e3), radius=50e3, n=200)

# 3D grid
config = particles_in_grid_3d(; x_max=G.Lx, y_max=G.Ly, z_max=0.0,
                               z_min=-G.Lz, nx=10, ny=10, nz=5)

# Multiple layers
config = particles_in_layers([-500.0, -1000.0, -2000.0];
                              x_max=G.Lx, y_max=G.Ly, nx=10, ny=10)</code></pre><hr/><h2 id="Boundary-Conditions"><a class="docs-heading-anchor" href="#Boundary-Conditions">Boundary Conditions</a><a id="Boundary-Conditions-1"></a><a class="docs-heading-anchor-permalink" href="#Boundary-Conditions" title="Permalink"></a></h2><h3 id="Horizontal-(Periodic)"><a class="docs-heading-anchor" href="#Horizontal-(Periodic)">Horizontal (Periodic)</a><a id="Horizontal-(Periodic)-1"></a><a class="docs-heading-anchor-permalink" href="#Horizontal-(Periodic)" title="Permalink"></a></h3><pre><code class="language-julia hljs">x_new = mod(x - x0, Lx) + x0
y_new = mod(y - y0, Ly) + y0</code></pre><h3 id="Vertical-(Reflective)"><a class="docs-heading-anchor" href="#Vertical-(Reflective)">Vertical (Reflective)</a><a id="Vertical-(Reflective)-1"></a><a class="docs-heading-anchor-permalink" href="#Vertical-(Reflective)" title="Permalink"></a></h3><p>Particles bounce off top (z=0) and bottom (z=-Lz):</p><pre><code class="language-julia hljs">config = particles_in_box(-2000.0; x_max=G.Lx, y_max=G.Ly,
    periodic_x=true,
    periodic_y=true,
    reflect_z=true
)</code></pre><hr/><h2 id="Trajectory-Output"><a class="docs-heading-anchor" href="#Trajectory-Output">Trajectory Output</a><a id="Trajectory-Output-1"></a><a class="docs-heading-anchor-permalink" href="#Trajectory-Output" title="Permalink"></a></h2><h3 id="Save-Interval"><a class="docs-heading-anchor" href="#Save-Interval">Save Interval</a><a id="Save-Interval-1"></a><a class="docs-heading-anchor-permalink" href="#Save-Interval" title="Permalink"></a></h3><pre><code class="language-julia hljs">config = particles_in_box(-2000.0; x_max=G.Lx, y_max=G.Ly,
    save_interval=10.0,       # Save every 10 time units
    max_save_points=1000      # Max points per file
)</code></pre><h3 id="Automatic-File-Splitting"><a class="docs-heading-anchor" href="#Automatic-File-Splitting">Automatic File Splitting</a><a id="Automatic-File-Splitting-1"></a><a class="docs-heading-anchor-permalink" href="#Automatic-File-Splitting" title="Permalink"></a></h3><p>For long simulations:</p><pre><code class="language-julia hljs">tracker = ParticleTracker(config, grid)
enable_auto_file_splitting!(tracker, &quot;long_run&quot;, max_points_per_file=500)

# Files: long_run.nc, long_run_part1.nc, long_run_part2.nc, ...</code></pre><h3 id="Delayed-Release"><a class="docs-heading-anchor" href="#Delayed-Release">Delayed Release</a><a id="Delayed-Release-1"></a><a class="docs-heading-anchor-permalink" href="#Delayed-Release" title="Permalink"></a></h3><p>Start advecting after flow develops:</p><pre><code class="language-julia hljs">config = particles_in_box(-2000.0; x_max=G.Lx, y_max=G.Ly,
    particle_advec_time=100.0  # Start at t=100
)</code></pre><hr/><h2 id="Output-Variables"><a class="docs-heading-anchor" href="#Output-Variables">Output Variables</a><a id="Output-Variables-1"></a><a class="docs-heading-anchor-permalink" href="#Output-Variables" title="Permalink"></a></h2><p>The trajectory file contains:</p><table><tr><th style="text-align: left">Variable</th><th style="text-align: left">Description</th></tr><tr><td style="text-align: left"><code>x, y, z</code></td><td style="text-align: left">Mean positions <span>$(X, Y, Z)$</span></td></tr><tr><td style="text-align: left"><code>xi_x, xi_y, xi_z</code></td><td style="text-align: left">Wave displacements <span>$(\xi_x, \xi_y, \xi_z)$</span></td></tr><tr><td style="text-align: left"><code>time</code></td><td style="text-align: left">Time stamps</td></tr><tr><td style="text-align: left"><code>id</code></td><td style="text-align: left">Particle IDs</td></tr></table><p>To reconstruct physical positions:</p><pre><code class="language-julia hljs">x_physical = x + xi_x
y_physical = y + xi_y
z_physical = z + xi_z</code></pre><hr/><h2 id="Parallel-Execution"><a class="docs-heading-anchor" href="#Parallel-Execution">Parallel Execution</a><a id="Parallel-Execution-1"></a><a class="docs-heading-anchor-permalink" href="#Parallel-Execution" title="Permalink"></a></h2><p>When running with MPI, particle advection uses domain decomposition automatically.</p><h3 id="Key-Features"><a class="docs-heading-anchor" href="#Key-Features">Key Features</a><a id="Key-Features-1"></a><a class="docs-heading-anchor-permalink" href="#Key-Features" title="Permalink"></a></h3><ul><li><strong>Halo exchange</strong>: Velocity data exchanged for boundary interpolation</li><li><strong>Particle migration</strong>: Particles transferred when they cross domain boundaries</li><li><strong>Consistent topology</strong>: Uses the same MPI decomposition as the fluid solver</li></ul><pre><code class="language-julia hljs">using MPI
using QGYBJplus

MPI.Init()
parallel_config = setup_mpi_environment()

tracker = ParticleTracker(particle_config, grid, parallel_config)
initialize_particles!(tracker, particle_config)

# Advection handles halo exchange and migration automatically
for step in 1:nsteps
    timestep!(sim)
    advect_particles!(tracker, sim.state, sim.grid, dt, current_time)
end

MPI.Finalize()</code></pre><hr/><h2 id="Visualization"><a class="docs-heading-anchor" href="#Visualization">Visualization</a><a id="Visualization-1"></a><a class="docs-heading-anchor-permalink" href="#Visualization" title="Permalink"></a></h2><h3 id="Plot-Positions"><a class="docs-heading-anchor" href="#Plot-Positions">Plot Positions</a><a id="Plot-Positions-1"></a><a class="docs-heading-anchor-permalink" href="#Plot-Positions" title="Permalink"></a></h3><pre><code class="language-julia hljs">using Plots

scatter(tracker.particles.x, tracker.particles.y,
    markersize=2, xlabel=&quot;x&quot;, ylabel=&quot;y&quot;, title=&quot;Particle Distribution&quot;)</code></pre><h3 id="Plot-Trajectories"><a class="docs-heading-anchor" href="#Plot-Trajectories">Plot Trajectories</a><a id="Plot-Trajectories-1"></a><a class="docs-heading-anchor-permalink" href="#Plot-Trajectories" title="Permalink"></a></h3><pre><code class="language-julia hljs">using NCDatasets

ds = NCDataset(&quot;particles.nc&quot;)
x_hist = ds[&quot;x&quot;][:]  # (np, ntime)
y_hist = ds[&quot;y&quot;][:]

# Plot first 50 tracks
plot(legend=false)
for i in 1:50
    plot!(x_hist[i,:], y_hist[i,:], alpha=0.3)
end</code></pre><h3 id="Animation"><a class="docs-heading-anchor" href="#Animation">Animation</a><a id="Animation-1"></a><a class="docs-heading-anchor-permalink" href="#Animation" title="Permalink"></a></h3><pre><code class="language-julia hljs">anim = @animate for t in 1:10:size(x_hist, 2)
    scatter(x_hist[:,t], y_hist[:,t], markersize=2,
        xlim=(0, Lx), ylim=(0, Ly), title=&quot;t = $(t)&quot;)
end
gif(anim, &quot;particles.gif&quot;, fps=20)</code></pre><hr/><h2 id="Key-Data-Structures"><a class="docs-heading-anchor" href="#Key-Data-Structures">Key Data Structures</a><a id="Key-Data-Structures-1"></a><a class="docs-heading-anchor-permalink" href="#Key-Data-Structures" title="Permalink"></a></h2><h3 id="ParticleConfig"><a class="docs-heading-anchor" href="#ParticleConfig">ParticleConfig</a><a id="ParticleConfig-1"></a><a class="docs-heading-anchor-permalink" href="#ParticleConfig" title="Permalink"></a></h3><pre><code class="language-julia hljs">struct ParticleConfig{T}
    x_min, x_max, y_min, y_max::T  # Horizontal domain
    z_level::T                      # Initial depth
    nx_particles, ny_particles::Int # Particle count

    use_ybj_w::Bool                # Vertical velocity source
    use_3d_advection::Bool         # Include vertical mean advection
    particle_advec_time::T         # Delayed start time
    interpolation_method           # TRILINEAR, TRICUBIC, etc.

    periodic_x, periodic_y::Bool   # Horizontal BCs
    reflect_z::Bool                # Vertical BCs

    save_interval::T               # Output frequency
    max_save_points::Int           # Max points per file
end</code></pre><h3 id="ParticleState"><a class="docs-heading-anchor" href="#ParticleState">ParticleState</a><a id="ParticleState-1"></a><a class="docs-heading-anchor-permalink" href="#ParticleState" title="Permalink"></a></h3><p>Contains particle data:</p><ul><li>Mean positions: <code>x, y, z</code></li><li>Particle IDs: <code>id</code></li><li>QG velocities: <code>u, v, w</code></li><li>Horizontal wave displacement: <code>xi_x, xi_y</code></li><li>Vertical wave displacement: <code>xi_z</code></li><li>Wave amplitude: <code>LA_real, LA_imag</code></li><li>Vertical displacement coefficients: <code>xi_z_cos, xi_z_sin</code></li></ul><hr/><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><ul><li><strong>Asselin, O. &amp; Young, W. R.</strong> (2019). Penetration of wind-generated near-inertial waves into a turbulent ocean. <em>J. Fluid Mech.</em>, 876, 428-448.</li><li><strong>Wagner, G. L. &amp; Young, W. R.</strong> (2016). A three-component model for the coupled evolution of near-inertial waves, quasi-geostrophic flow and the near-inertial second harmonic. <em>J. Fluid Mech.</em>, 802, 806-837.</li></ul><h2 id="API-Reference"><a class="docs-heading-anchor" href="#API-Reference">API Reference</a><a id="API-Reference-1"></a><a class="docs-heading-anchor-permalink" href="#API-Reference" title="Permalink"></a></h2><p>See the <a href="../../api/particles/">Particle API Reference</a> for complete documentation.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../parallel/">« MPI Parallelization</a><a class="docs-footer-nextpage" href="../parallel_particles/">Parallel Particle Algorithm »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Saturday 24 January 2026 15:50">Saturday 24 January 2026</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
